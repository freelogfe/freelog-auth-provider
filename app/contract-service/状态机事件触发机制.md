# 飞致网络智能合约事件执行触发实现机制.

1.所有合同事件起源必须从合同主体出发.不能脱离合同.

2.合同事件(非自然事件)触发顺序为:
  A.用户尝试发起合同事件.
  B.合同服务根据上下文环境(用户,合同状态,事件类型)进行逻辑判断.然后再根据事件类型实现去实现不同业务(例如支付事件,则合同服务校验完毕后,创建合同订单,然后调用支付服务).
  C.合同服务在处理完成事件的具体业务场景后,发送事件给具体合同状态机.
  D.合同状态机接收事件,并且根据合同策略,做出状态转移.并且更新合同相关内容和状态.

3.根据上面两条情况,修改之前的合同逻辑.例如之前的交易事件.旧的实现为接受transaction_feth10000abc_199_event事件.然后直接修改状态机状态
  因为事件的发起方不一定起源以合同,也可能是在支付账号管理界面直接转账.这样具体关联的合同ID和金额就存在人为约定输入或者绑定的过程,可能出现偏差.导致交易无效以及其他纠纷.也避免了合并记账等问题
  如果从合同主体发起支付事件,则支付金额.收款账号,合同ID等信息均不会出错.同时降低用户理解与操作成本.因为事件在发起过程中,合同服务全程监管,所以在这个过程中
  的所有数据和流程都可以把控.而不是仅仅只能接受到事件已经执行完毕的后半部分结果.


# 合同服务与合同状态机的关系

1.合同服务接收和处理外部发起的合同事件
2.合同服务校验和处理事件相关的逻辑以及相关记录
3.合同服务校验完毕,发送事件给(或调用)合同状态机.
4.合同状态机接受事件并且更改状态.
5.其他内部系统可以订阅合同状态机改变事件,做出对应的逻辑处理.


# 具体事件类型的处理逻辑

1.签约license事件
  A.用户从合同界面尝试发起签约事件.
  B.前端UI根据签约事件的参数,把license内容调用出来,依次让用户签名(或同意)
  C.前端发送签约license事件到合同服务,合同服务校验用户签约情况.记录签约记录.
  D.合同服务校验成功,发送签约事件到合同状态机.合同状态机更改合同.校验失败,返回错误给前端 <完毕>

2.支付事件(包括支付保证金)
  A.用户从合同界面尝试发起签约事件.
  B.前端UI根据支付事件的参数,弹框让用户选择付款账户和输入密码.确认合同的金额等信息.
  C.前端发送支付事件的参数信息给合同服务,合同服务校验信息.校验失败,返回错误给前端.
  D.合同服务校验成功,则创建支付订单.然后系统内部调用支付API.支付失败,则返回错误给前端.
  E.支付成功,则修改订单状态等信息.然后发送支付事件到合同状态机,合同状态机更改合同. <完毕>

3.周期结束事件(自然事件)
  A.飞致网络事件服务定时触发周期结束事件.
  B.事件注册服务接收到周期结束事件,则查询之前所有已注册过周期事件的合同.然后遍历触发这些合同的周期结束事件.
  C.合同服务接收到周期到期事件,发送事件给合同状态机.合同状态机更改合同. <完毕>






